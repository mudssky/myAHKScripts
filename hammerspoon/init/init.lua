-- Hammerspoon Configuration
-- Auto-generated by load_scripts.zsh
-- è‡ªåŠ¨ç”Ÿæˆçš„Hammerspooné…ç½®æ–‡ä»¶

-- è®¾ç½®æ—¥å¿—çº§åˆ«
hs.logger.defaultLogLevel = 'info'

-- åˆ›å»ºä¸»æ—¥å¿—è®°å½•å™¨
local log = hs.logger.new('main', 'info')

-- æ˜¾ç¤ºåŠ è½½å¼€å§‹æ¶ˆæ¯
log.i("å¼€å§‹åŠ è½½Hammerspooné…ç½®...")

-- è·å–é…ç½®ç›®å½•è·¯å¾„
local configDir = hs.configdir
local scriptsDir = configDir .. "/scripts"

-- åˆ›å»ºscriptsç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
local scriptsPath = hs.fs.pathToAbsolute(scriptsDir)
if not scriptsPath then
    hs.fs.mkdir(scriptsDir)
    log.i("åˆ›å»ºscriptsç›®å½•: " .. scriptsDir)
end

-- åŠ è½½æ‰€æœ‰luaè„šæœ¬çš„å‡½æ•°
local function loadLuaScripts(directory)
    local loadedCount = 0
    local errorCount = 0
    
    log.i("æ‰«æç›®å½•: " .. directory)
    
    -- éå†ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
    for file in hs.fs.dir(directory) do
        if file:match("%.lua$") and file ~= "init.lua" then
            local filePath = directory .. "/" .. file
            local relativePath = file
            
            log.i("å°è¯•åŠ è½½: " .. relativePath)
            
            -- å°è¯•åŠ è½½è„šæœ¬
            local success, result = pcall(function()
                return dofile(filePath)
            end)
            
            if success then
                log.i("âœ… æˆåŠŸåŠ è½½: " .. relativePath)
                loadedCount = loadedCount + 1
            else
                log.e("âŒ åŠ è½½å¤±è´¥: " .. relativePath .. " - " .. tostring(result))
                errorCount = errorCount + 1
            end
        end
    end
    
    return loadedCount, errorCount
end

-- åŠ è½½ä¸»é…ç½®ç›®å½•ä¸­çš„luaæ–‡ä»¶
local mainLoaded, mainErrors = loadLuaScripts(configDir)

-- åŠ è½½scriptså­ç›®å½•ä¸­çš„luaæ–‡ä»¶
local scriptsLoaded, scriptsErrors = loadLuaScripts(scriptsDir)

-- æ€»è®¡
local totalLoaded = mainLoaded + scriptsLoaded
local totalErrors = mainErrors + scriptsErrors

-- æ˜¾ç¤ºåŠ è½½ç»“æœ
if totalLoaded > 0 then
    local message = string.format("ğŸ‰ Hammerspooné…ç½®åŠ è½½å®Œæˆ!\nâœ… æˆåŠŸ: %dä¸ªè„šæœ¬\nâŒ å¤±è´¥: %dä¸ªè„šæœ¬", totalLoaded, totalErrors)
    hs.alert.show(message, 3)
    log.i(message)
else
    local message = "âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯åŠ è½½çš„luaè„šæœ¬"
    hs.alert.show(message, 2)
    log.w(message)
end

-- è®¾ç½®é…ç½®æ–‡ä»¶é‡æ–°åŠ è½½å¿«æ·é”®
hs.hotkey.bind({"cmd", "alt", "ctrl"}, "R", function()
    hs.reload()
end)

hs.alert.show("æŒ‰ Cmd+Alt+Ctrl+R é‡æ–°åŠ è½½é…ç½®", 2)

-- ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨é‡æ–°åŠ è½½
local function reloadConfig(files)
    local doReload = false
    for _, file in pairs(files) do
        if file:sub(-4) == ".lua" then
            doReload = true
            break
        end
    end
    if doReload then
        hs.timer.doAfter(0.5, function()
            hs.reload()
        end)
    end
end

-- ç›‘å¬é…ç½®ç›®å½•å˜åŒ–
local configWatcher = hs.pathwatcher.new(configDir, reloadConfig)
configWatcher:start()

-- ç›‘å¬scriptsç›®å½•å˜åŒ–
local scriptsWatcher = hs.pathwatcher.new(scriptsDir, reloadConfig)
scriptsWatcher:start()

log.i("é…ç½®æ–‡ä»¶ç›‘å¬å·²å¯åŠ¨")
log.i("Hammerspooné…ç½®åŠ è½½å®Œæˆ!")